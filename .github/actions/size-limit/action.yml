name: 'Size Limit Check'
description: 'Run size-limit checks and post results as a PR comment'
inputs:
  github_token:
    description: 'GitHub token for API access'
    required: true
  turbo_token:
    description: 'Turbo token for remote caching'
    required: false
  turbo_team:
    description: 'Turbo team name'
    required: false
  filter:
    description: 'Turbo filter for packages to check'
    required: false
    default: './packages/*'
runs:
  using: 'composite'
  steps:
    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: 1.2.22
    - name: Install dependencies
      run: bun install
      working-directory: ${{ github.action_path }}
    - name: Run size checks
      id: size-check
      shell: bash
      env:
        INPUT_GITHUB_TOKEN: ${{ inputs.github_token }}
        INPUT_TURBO_TOKEN: ${{ inputs.turbo_token }}
        INPUT_TURBO_TEAM: ${{ inputs.turbo_team }}
        INPUT_FILTER: ${{ inputs.filter }}
      run: |
        bun ${{ github.action_path }}/run-size-check.ts
    - name: Comment PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.github_token }}
        script: |
          const output = `${{ steps.size-check.outputs.result }}`;
          const hasErrors = `${{ steps.size-check.outputs.has_errors }}` === 'true';
          
          const comment = `## ðŸ“¦ Bundle Size Report
          
          ${output}
          
          ${hasErrors ? 'âŒ **Size limits exceeded!** Please review the changes above.' : 'âœ… **All size limits passed!**'}
          `;
          
          // Find existing comment
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && comment.body.includes('Bundle Size Report')
          );
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: comment,
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment,
            });
          }

