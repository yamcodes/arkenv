name: 'Size Limit Check'
description: 'Run size-limit checks and post results as a PR comment'
inputs:
  github_token:
    description: 'GitHub token for API access'
    required: true
  turbo_token:
    description: 'Turbo token for remote caching'
    required: false
  turbo_team:
    description: 'Turbo team name'
    required: false
  filter:
    description: 'Turbo filter for packages to check'
    required: false
    default: './packages/*'
runs:
  using: 'composite'
  steps:
    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: 1.3.5
    - name: Install dependencies
      shell: bash
      run: bun install
      working-directory: ${{ github.action_path }}
    - name: Run size checks
      id: size-check
      shell: bash
      env:
        INPUT_GITHUB_TOKEN: ${{ inputs.github_token }}
        INPUT_TURBO_TOKEN: ${{ inputs.turbo_token }}
        INPUT_TURBO_TEAM: ${{ inputs.turbo_team }}
        INPUT_FILTER: ${{ inputs.filter }}
        INPUT_BASE_BRANCH: ${{ github.event.pull_request.base.ref || github.base_ref || 'main' }}
        INPUT_HEAD_BRANCH: ${{ github.event.pull_request.head.ref || '' }}
        GITHUB_EVENT_NAME: ${{ github.event_name }}
      run: |
        bun ${{ github.action_path }}/src/index.ts
    - name: Comment PR
      if: github.event_name == 'pull_request' && steps.size-check.outputs.packages_changed == 'true'
      uses: actions/github-script@v8
      with:
        github-token: ${{ inputs.github_token }}
        script: |
          const output = process.env.SIZE_LIMIT_RESULT ?? '';
          const hasErrors = (process.env.SIZE_LIMIT_HAS_ERRORS ?? 'false') === 'true';
          const comment = `## ðŸ“¦ Bundle Size Report
          
          ${output}
          
          ${hasErrors ? 'âŒ **Size limits exceeded!** Please review the changes above.' : 'âœ… **All size limits passed!**'}
          `;
          
          try {
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user?.type === 'Bot' &&
              comment.user?.login === 'arkenv-bot[bot]' &&
              comment.body?.includes('Bundle Size Report')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment,
              });
            }
          } catch (error) {
            if (error?.status === 403) {
              core.warning('Failed to post PR comment due to insufficient permissions. This is expected for forks.');
            } else {
              core.setFailed(`Failed to post PR comment: ${error?.message || error}`);
            }
            console.error('Error details:', error);
          }
      env:
        SIZE_LIMIT_RESULT: ${{ steps.size-check.outputs.result }}
        SIZE_LIMIT_HAS_ERRORS: ${{ steps.size-check.outputs.has_errors }}
